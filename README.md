# Digital Companion Server

è¿™æ˜¯ä¸€ä¸ªåŸºäº Spring Boot 3.4.0 å’Œ Java 21 æ„å»ºçš„åç«¯æœåŠ¡é¡¹ç›®ï¼Œæ—¨åœ¨æä¾›æ•°å­—ä¼´ä¾£/å¿ƒç†å¥åº·è¾…åŠ©ç›¸å…³çš„æœåŠ¡ã€‚é¡¹ç›®é›†æˆäº†ç”¨æˆ·ç®¡ç†ã€æŠ‘éƒè¯„ä¼°ã€æ—¥è®°è®°å½•ã€éŸ³ä¹æ¨èä»¥åŠåŸºäº LLM (Ollama) çš„ AI å¯¹è¯åŠŸèƒ½ã€‚

æ­¤å¤–ï¼Œæœ¬é¡¹ç›®è¿˜åŒ…å«ä¸€ä¸ªé…å¥—çš„ TypeScript SDK (`Client/` ç›®å½•)ï¼Œæ–¹ä¾¿å‰ç«¯åº”ç”¨ï¼ˆWeb/Node/Tauriï¼‰å¿«é€Ÿæ¥å…¥ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

*   **ç”¨æˆ·ç³»ç»Ÿ**
    *   ğŸ” **å®‰å…¨è®¤è¯**: åŸºäº JWT çš„æ— çŠ¶æ€è®¤è¯æœºåˆ¶ï¼Œæ”¯æŒ Token è‡ªåŠ¨åˆ·æ–°ä¸é»‘åå•ç®¡ç†ã€‚
    *   ğŸ‘¤ **ä¸ªäººä¸­å¿ƒ**: å®Œæ•´çš„ç”¨æˆ·ç”»åƒç®¡ç†ï¼ŒåŒ…æ‹¬å¤´åƒã€ç­¾åã€ä¸ªæ€§åŒ–åå¥½è®¾ç½®ã€‚
    *   ğŸ“§ **é‚®ä»¶æœåŠ¡**: é›†æˆé‚®ä»¶é€šçŸ¥æœåŠ¡ï¼Œç”¨äºè´¦å·éªŒè¯ä¸é£é™©é¢„è­¦ã€‚
*   **å¿ƒç†å¥åº·ä¸è¯„ä¼°**
    *   ğŸ“Š **ä¸“ä¸šé‡è¡¨**: å†…ç½® PHQ-9 ç­‰ä¸“ä¸šæŠ‘éƒè¯„ä¼°é‡è¡¨ï¼Œæä¾›ç§‘å­¦çš„è¯„åˆ†ä¸åˆ†æã€‚
    *   ğŸ§  **å¿ƒç†çŸ¥è¯†åº“**: ç»“æ„åŒ–çš„å¿ƒç†å­¦çŸ¥è¯†ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒçŸ¥è¯†æ£€ç´¢ä¸ç§‘æ™®ã€‚
    *   ğŸ›¡ï¸ **å¤šæ¨¡æ€é£é™©æ£€æµ‹**: ç»“åˆè§„åˆ™å¼•æ“ã€æƒ…æ„Ÿåˆ†æä¸ LLM è¯­ä¹‰è¯†åˆ«çš„æ··åˆæ£€æµ‹æœºåˆ¶ã€‚
*   **AI ä¼´ä¾£ (LLM)**
    *   ğŸ¤– **æ™ºèƒ½å¯¹è¯**: é›†æˆ Ollama æœ¬åœ°å¤§æ¨¡å‹ï¼Œæä¾›æµç•…çš„æƒ…æ„Ÿé™ªä¼´ä¸å¯¹è¯ã€‚
    *   ğŸŒ **è”ç½‘èƒ½åŠ›**: æ”¯æŒ Web Search ä¸ç½‘é¡µå†…å®¹æŠ“å–ï¼Œèµ‹äºˆ AI å®æ—¶è·å–ä¿¡æ¯çš„èƒ½åŠ›ã€‚
    *   ğŸ’¾ **ä¼šè¯è®°å¿†**: å®Œæ•´çš„ä¼šè¯å†å²è®°å½•ä¸ä¸Šä¸‹æ–‡ç®¡ç†ã€‚
*   **ç”Ÿæ´»è®°å½•**
    *   ğŸ“” **æƒ…ç»ªæ—¥è®°**: è®°å½•æ—¥å¸¸ç‚¹æ»´ä¸å¿ƒæƒ…å˜åŒ–ï¼Œæ”¯æŒæƒ…ç»ªè¶‹åŠ¿åˆ†æã€‚
*   **ç¤¾åŒºä¸å¨±ä¹**
    *   ğŸ‘¥ **äº’åŠ©ç¤¾åŒº**: åŒ¿åæˆ–å®åçš„ç¤¾åŒºäº’åŠ¨ç©ºé—´ã€‚
    *   ğŸµ **éŸ³ä¹ç–—æ„ˆ**: åŸºäºç”¨æˆ·æƒ…ç»ªçŠ¶æ€æ¨èèˆ’ç¼“éŸ³ä¹ã€‚
*   **ç®¡ç†åå°**
    *   ğŸ› ï¸ **ç³»ç»Ÿç®¡ç†**: ç”¨æˆ·ç®¡ç†ã€å†…å®¹å®¡æ ¸ã€ç³»ç»Ÿç›‘æ§ç­‰ç®¡ç†å‘˜åŠŸèƒ½ã€‚

## ğŸ— ç³»ç»Ÿæ¶æ„

```mermaid
graph TD
    Client["å®¢æˆ·ç«¯ (Web/App)"] -->|HTTP/REST| Controller["API ç½‘å…³"]
    Controller --> Service["ä¸šåŠ¡é€»è¾‘å±‚"]
    
    subgraph "æ ¸å¿ƒæœåŠ¡"
        Service --> Auth["è®¤è¯æœåŠ¡ (JWT)"]
        Service --> User["ç”¨æˆ·æœåŠ¡"]
        Service --> Diary["æ—¥è®°æœåŠ¡"]
        Service --> Assessment["è¯„ä¼°æœåŠ¡"]
    end
    
    subgraph "AI & æ£€æµ‹å¼•æ“"
        Service -->|åŒæ­¥/å¼‚æ­¥| LLM_Agent["LLM æ™ºèƒ½ä½“"]
        LLM_Agent -->|è°ƒç”¨| Ollama["Ollama æœ¬åœ°æ¨¡å‹"]
        LLM_Agent -->|å·¥å…·è°ƒç”¨| WebSearch["è”ç½‘æœç´¢"]
        
        Service -->|æ¶ˆæ¯æŠ•é€’| MQ["RabbitMQ"]
        MQ -->|æ¶ˆè´¹| Detector["é£é™©æ£€æµ‹æ¶ˆè´¹è€…"]
        Detector --> Rule["è§„åˆ™å¼•æ“"]
        Detector --> Emotion["æƒ…æ„Ÿåˆ†æ"]
        Detector --> LLM_Check["LLM è¯­ä¹‰åˆ†æ"]
    end
    
    subgraph "æ•°æ®å­˜å‚¨"
        Service --> MySQL[("MySQL æ•°æ®åº“")]
        Detector --> MySQL
    end
```

## ğŸ’¡ æ ¸å¿ƒç‰¹æ€§æ·±åº¦è§£æ

### 1. å¤šæ¨¡æ€é£é™©æ£€æµ‹å¼•æ“

ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚é˜²æŠ¤æœºåˆ¶æ¥å®æ—¶ç›‘æµ‹ç”¨æˆ·çš„å¿ƒç†å¥åº·çŠ¶æ€ï¼š

*   **Layer 1: è§„åˆ™å¼•æ“ (`RuleBasedRiskDetector`)**
    *   åŸºäºå…³é”®è¯åŒ¹é…å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œå¿«é€Ÿè¯†åˆ«æ˜æ˜¾çš„è‡ªæ€å€¾å‘æˆ–é«˜å±è¨€è®ºã€‚
    *   å“åº”é€Ÿåº¦æœ€å¿«ï¼Œä½œä¸ºç¬¬ä¸€é“é˜²çº¿ã€‚
*   **Layer 2: æƒ…æ„Ÿåˆ†æ (`EmotionRiskDetector`)**
    *   åˆ†ææ–‡æœ¬çš„æƒ…æ„Ÿææ€§ï¼ˆPolarityï¼‰å’Œå¼ºåº¦ã€‚
    *   è¯†åˆ«æŒç»­çš„è´Ÿé¢æƒ…ç»ªæ³¢åŠ¨ã€‚
*   **Layer 3: LLM è¯­ä¹‰åˆ†æ (`LlmRiskDetector`)**
    *   åˆ©ç”¨å¤§æ¨¡å‹çš„æ·±åº¦è¯­ä¹‰ç†è§£èƒ½åŠ›ï¼Œè¯†åˆ«éšæ™¦çš„æ±‚æ•‘ä¿¡å·æˆ–å¤æ‚çš„å¿ƒç†å›°æ‰°ã€‚
    *   ç»“åˆä¸Šä¸‹æ–‡å†å²ï¼Œè¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚

### 2. å¼‚æ­¥å¤„ç†æ¶æ„ (RabbitMQ)

ä¸ºäº†ä¿è¯ç”¨æˆ·å¯¹è¯çš„æµç•…æ€§ï¼Œè€—æ—¶çš„é£é™©æ£€æµ‹ä»»åŠ¡è¢«å‰¥ç¦»åˆ°å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­å¤„ç†ï¼š

*   **æ¶ˆæ¯æµè½¬**: ç”¨æˆ·å‘é€æ¶ˆæ¯ -> å­˜å…¥æ•°æ®åº“ -> æŠ•é€’åˆ° RabbitMQ -> ç«‹å³å“åº”ç”¨æˆ·ã€‚
*   **å¯é æ€§**: é‡‡ç”¨æŒä¹…åŒ–é˜Ÿåˆ—å’Œæ­»ä¿¡é˜Ÿåˆ— (DLQ) æœºåˆ¶ï¼Œç¡®ä¿æ£€æµ‹ä»»åŠ¡ä¸ä¸¢å¤±ã€‚
*   **å‰Šå³°å¡«è°·**: åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæœ‰æ•ˆç¼“å†²æ£€æµ‹è¯·æ±‚ï¼Œä¿æŠ¤åç«¯æœåŠ¡ã€‚

### 3. æ™ºèƒ½ä½“å·¥ä½œæµ (Agent Workflow)

AI ä¼´ä¾£ä¸ä»…ä»…æ˜¯ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œå®ƒå…·å¤‡ä½¿ç”¨å·¥å…·çš„èƒ½åŠ›ï¼š

*   **Web Search**: å½“ç”¨æˆ·è¯¢é—®æ—¶äº‹æ–°é—»æˆ–ç‰¹å®šçŸ¥è¯†æ—¶ï¼ŒAI ä¼šè‡ªåŠ¨è°ƒç”¨æœç´¢å·¥å…·ã€‚
*   **Content Fetch**: è·å–æœç´¢ç»“æœçš„è¯¦ç»†ç½‘é¡µå†…å®¹ï¼Œè¿›è¡Œé˜…è¯»ç†è§£å’Œæ€»ç»“ã€‚
*   **å·¥ä½œæµ**: `ç”¨æˆ·æé—®` -> `æ„å›¾è¯†åˆ«` -> `è°ƒç”¨æœç´¢` -> `é˜…è¯»å†…å®¹` -> `ç”Ÿæˆå›ç­”`ã€‚

## ğŸ›  æŠ€æœ¯æ ˆ

*   **ç¼–ç¨‹è¯­è¨€**: Java 21
*   **æ ¸å¿ƒæ¡†æ¶**: Spring Boot 3.4.0
*   **æŒä¹…å±‚**: MyBatis 3.0.4
*   **æ•°æ®åº“**: MySQL 8.0
*   **å®‰å…¨æ¡†æ¶**: Spring Security (JWT)
*   **AI/LLM**: Ollama é›†æˆ
*   **æ„å»ºå·¥å…·**: Maven
*   **å®¹å™¨åŒ–**: Docker & Docker Compose (ç”¨äºæ•°æ®åº“éƒ¨ç½²)

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
Server/
â”œâ”€â”€ Client/                 # TypeScript SDK æºç åŠæ–‡æ¡£
â”œâ”€â”€ docs/                   # è¯¦ç»†é¡¹ç›®æ–‡æ¡£ (JWT, Admin, Guidesç­‰)
â”œâ”€â”€ sql/                    # æ•°æ®åº“åˆå§‹åŒ–ä¸è¿ç§»è„šæœ¬
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/dev/x/     # Java æºä»£ç 
â”‚   â”‚   â”‚   â”œâ”€â”€ controller/ # API æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ service/    # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ mapper/     # MyBatis Mapper
â”‚   â”‚   â”‚   â”œâ”€â”€ entity/     # æ•°æ®åº“å®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ llm/        # LLM é›†æˆæ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.yml # é¡¹ç›®é…ç½®
â”‚   â”‚       â””â”€â”€ prompt/     # LLM æç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ docker-compose.yml      # MySQL éƒ¨ç½²é…ç½®
â”œâ”€â”€ pom.xml                 # Maven ä¾èµ–é…ç½®
â””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

*   JDK 21+
*   Maven 3.x
*   Docker & Docker Compose
*   Ollama (å¦‚æœéœ€è¦ä½¿ç”¨ AI åŠŸèƒ½)

### 1. å¯åŠ¨æ•°æ®åº“

é¡¹ç›®æ ¹ç›®å½•ä¸‹æä¾›äº† `docker-compose.yml` æ–‡ä»¶ï¼Œå¯å¿«é€Ÿå¯åŠ¨ MySQL æœåŠ¡ã€‚

```bash
docker-compose up -d
```

é»˜è®¤é…ç½®ï¼š
*   ç«¯å£: `3306`
*   æ•°æ®åº“å: `digital_companion`
*   Root å¯†ç : `passwd`

### 2. é…ç½®é¡¹ç›®

ä¿®æ”¹ `src/main/resources/application.yml` æ–‡ä»¶ï¼Œé…ç½®ä½ çš„æ•°æ®åº“è¿æ¥å’Œé‚®ä»¶æœåŠ¡ä¿¡æ¯ï¼š

```yaml
spring:
  datasource:
    url: jdbc:mysql://127.0.0.1:3306/digital_companion
    username: root
    password: passwd # è¯·ç¡®ä¿ä¸ docker-compose ä¸­ä¸€è‡´
  mail:
    host: smtp.qq.com # ä½ çš„é‚®ä»¶æœåŠ¡å™¨
    username: your_email@example.com
    password: your_password
```

### 3. ç¼–è¯‘ä¸è¿è¡Œ

```bash
# ç¼–è¯‘é¡¹ç›®
mvn clean install

# è¿è¡Œé¡¹ç›®
mvn spring-boot:run
```

æœåŠ¡å¯åŠ¨åï¼Œé»˜è®¤è¿è¡Œåœ¨ `8080` ç«¯å£ï¼ˆå…·ä½“è§†é…ç½®è€Œå®šï¼‰ã€‚

## âš™ï¸ é…ç½®è¯¦è§£

### ç¯å¢ƒå˜é‡

é¡¹ç›®æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤é…ç½®ï¼Œæ–¹ä¾¿å®¹å™¨åŒ–éƒ¨ç½²ï¼š

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `SPRING_DATASOURCE_URL` | `jdbc:mysql://127.0.0.1:3306/digital_companion` | æ•°æ®åº“è¿æ¥åœ°å€ |
| `SPRING_DATASOURCE_USERNAME` | `root` | æ•°æ®åº“ç”¨æˆ·å |
| `SPRING_DATASOURCE_PASSWORD` | `password` | æ•°æ®åº“å¯†ç  |
| `SPRING_MAIL_HOST` | `smtp.qq.com` | SMTP æœåŠ¡å™¨åœ°å€ |
| `SPRING_MAIL_USERNAME` | `Hughsean@qq.com` | å‘ä»¶äººé‚®ç®± |
| `SPRING_MAIL_PASSWORD` | `lrgbulnorlvwbaii` | é‚®ç®±æˆæƒç  |
| `SPRING_RABBITMQ_HOST` | `localhost` | RabbitMQ ä¸»æœº |
| `SPRING_RABBITMQ_PORT` | `5672` | RabbitMQ ç«¯å£ |
| `SPRING_RABBITMQ_USERNAME` | `guest` | RabbitMQ ç”¨æˆ·å |
| `SPRING_RABBITMQ_PASSWORD` | `guest` | RabbitMQ å¯†ç  |

### RabbitMQ é…ç½®

å¦‚æœå¯ç”¨äº†å¼‚æ­¥é£é™©æ£€æµ‹ï¼Œè¯·ç¡®ä¿ RabbitMQ æœåŠ¡å·²å¯åŠ¨ï¼Œå¹¶åˆ›å»ºäº†ç›¸åº”çš„ Exchange å’Œ Queueï¼ˆç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å°è¯•åˆ›å»ºï¼‰ï¼š

*   **Exchange**: `risk.detection.exchange` (Direct)
*   **Queue**: `risk.detection.queue`
*   **Routing Key**: `risk.detection`

## ğŸ“¦ Client SDK

é¡¹ç›®åŒ…å«ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„ TypeScript SDKï¼Œä½äº `Client/` ç›®å½•ä¸‹ã€‚å®ƒæä¾›äº†ç±»å‹å®‰å…¨çš„ API è°ƒç”¨æ–¹å¼ï¼Œæ”¯æŒ Browserã€Node.js å’Œ Tauri ç¯å¢ƒã€‚

**å®‰è£…ä¸ä½¿ç”¨ï¼š**

è¯·å‚è€ƒ [Client/README.md](Client/README.md) è·å–è¯¦ç»†çš„å®‰è£…å’Œä½¿ç”¨æŒ‡å—ã€‚

```typescript
import { UsersApi, updateApiConfig } from './Client/src';

// é…ç½® API åœ°å€
updateApiConfig({ baseURL: 'http://localhost:8080' });

// è°ƒç”¨ API
const users = new UsersApi();
const user = await users.getById(1);
```

## ğŸ“š æ–‡æ¡£

æ›´å¤šè¯¦ç»†æ–‡æ¡£è¯·æŸ¥é˜… `docs/` ç›®å½•ï¼š

*   [JWT è®¤è¯æŒ‡å—](docs/JWT_AUTHENTICATION_GUIDE.md)
*   [ç®¡ç†å‘˜ API æŒ‡å—](docs/ADMIN_API_KEY_GUIDE.md)
*   [RabbitMQ é›†æˆ](docs/RABBITMQ_INTEGRATION.md)
*   [æ›´å¤šæ–‡æ¡£...](docs/)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) å¼€æºè®¸å¯è¯ã€‚
